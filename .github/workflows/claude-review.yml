name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      contains(github.event.comment.body, '@claude') &&
      !contains(toLower(github.event.comment.body), 'merge') &&
      !contains(toLower(github.event.comment.body), 'lgtm') &&
      !contains(toLower(github.event.comment.body), 'ship it') &&
      !contains(toLower(github.event.comment.body), 'approve') &&
      (github.event.issue.pull_request || github.event.pull_request)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.payload.issue) {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
            }
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('number', pr.number);
            return pr;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract request from comment
        id: request
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const request = comment.replace(/@claude\s*/gi, '').trim();
            core.setOutput('request', request);

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude-code --print "${{ steps.request.outputs.request }}"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Claude Code"
          git config user.email "claude-code[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Apply changes from review feedback

          Requested by: @${{ github.event.comment.user.login }}

          Co-Authored-By: Claude Code <claude-code[bot]@users.noreply.github.com>"
          git push

      - name: Reply to comment
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            const body = hasChanges
              ? 'âœ… Changes applied and pushed to this PR.'
              : 'ðŸ‘€ I reviewed the request but no code changes were needed.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });
