name: Claude Auto-Merge

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  auto-merge:
    # Trigger on approval OR @claude merge/lgtm comment
    if: |
      (github.event.review.state == 'approved') ||
      (github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude') &&
       (contains(toLower(github.event.comment.body), 'merge') ||
        contains(toLower(github.event.comment.body), 'lgtm') ||
        contains(toLower(github.event.comment.body), 'ship it') ||
        contains(toLower(github.event.comment.body), 'approve')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.issue) {
              prNumber = context.payload.issue.number;
            } else if (context.payload.review) {
              prNumber = context.payload.review.pull_request.number;
            }
            core.setOutput('number', prNumber);

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('mergeable', pr.mergeable);
            return pr;

      - name: Approve PR (if from comment)
        if: github.event.comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              event: 'APPROVE',
              body: 'âœ… Approved via `@claude merge` command'
            });

      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Try to enable auto-merge (requires merge queue or auto-merge enabled)
              await github.rest.pulls.updateBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }}
              });
            } catch (e) {
              console.log('Could not update branch:', e.message);
            }

            // Enable auto-merge
            const mutation = `
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;

            try {
              // Get PR node ID
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }}
              });

              await github.graphql(mutation, {
                pullRequestId: pr.node_id
              });

              console.log('Auto-merge enabled');
            } catch (e) {
              console.log('Could not enable auto-merge:', e.message);
              // Fall back to adding to merge queue or direct merge
            }

      - name: Comment status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: 'ðŸš€ Auto-merge enabled! This PR will merge once all checks pass.'
            });

  # Batch merge for multiple PRs
  batch-merge:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      contains(toLower(github.event.comment.body), 'merge all')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get all open PRs in chain
        id: prs
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });

            // Filter to step PRs and sort by step number
            const stepPrs = prs
              .filter(pr => pr.head.ref.startsWith('pr/step-'))
              .sort((a, b) => {
                const aNum = parseFloat(a.head.ref.match(/step-(\d+[-.]?\d*)/)?.[1] || 0);
                const bNum = parseFloat(b.head.ref.match(/step-(\d+[-.]?\d*)/)?.[1] || 0);
                return aNum - bNum;
              });

            core.setOutput('prs', JSON.stringify(stepPrs.map(p => p.number)));
            return stepPrs;

      - name: Enable auto-merge on all PRs
        uses: actions/github-script@v7
        with:
          script: |
            const prNumbers = JSON.parse('${{ steps.prs.outputs.prs }}');

            for (const prNumber of prNumbers) {
              try {
                // Approve
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  event: 'APPROVE',
                  body: 'âœ… Batch approved via `@claude merge all`'
                });

                // Get PR node ID and enable auto-merge
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });

                const mutation = `
                  mutation($pullRequestId: ID!) {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: $pullRequestId,
                      mergeMethod: SQUASH
                    }) {
                      pullRequest { autoMergeRequest { enabledAt } }
                    }
                  }
                `;

                await github.graphql(mutation, { pullRequestId: pr.node_id });
                console.log(`Auto-merge enabled for PR #${prNumber}`);
              } catch (e) {
                console.log(`Error on PR #${prNumber}:`, e.message);
              }
            }

      - name: Comment summary
        uses: actions/github-script@v7
        with:
          script: |
            const prNumbers = JSON.parse('${{ steps.prs.outputs.prs }}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸš€ Auto-merge enabled for ${prNumbers.length} PRs: ${prNumbers.map(n => '#' + n).join(', ')}\n\nThey will merge in order once checks pass.`
            });
